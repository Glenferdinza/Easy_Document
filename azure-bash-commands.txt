# Perintah Azure CLI untuk Cloud Shell (Bash)
# Salin dan jalankan perintah ini satu per satu di Azure Cloud Shell Anda

# 1. Set variables
RESOURCE_GROUP="compress-img-rg"
APP_NAME="compress-img-app" 
LOCATION="eastus"
REPO_URL="https://github.com/Glenferdinza/composser_compress-convert-file.git"

# 2. Buat resource group
az group create --name $RESOURCE_GROUP --location $LOCATION

# 3. Buat App Service Plan (Free F1 tier - $0/bulan)
az appservice plan create \
  --name "${APP_NAME}-plan" \
  --resource-group $RESOURCE_GROUP \
  --sku F1 \
  --is-linux

# 4. Buat Web App dengan Python 3.12
az webapp create \
  --resource-group $RESOURCE_GROUP \
  --plan "${APP_NAME}-plan" \
  --name $APP_NAME \
  --runtime "PYTHON|3.12"

# 5. Konfigurasi deployment dari GitHub
az webapp deployment source config \
  --resource-group $RESOURCE_GROUP \
  --name $APP_NAME \
  --repo-url $REPO_URL \
  --branch main \
  --manual-integration

# 6. Set environment variables untuk Django
az webapp config appsettings set \
  --resource-group $RESOURCE_GROUP \
  --name $APP_NAME \
  --settings \
    DJANGO_SETTINGS_MODULE=backend.settings \
    PYTHONPATH=/home/site/wwwroot \
    WEBSITES_PORT=8000 \
    DEBUG=False \
    ALLOWED_HOSTS="${APP_NAME}.azurewebsites.net"

# 7. Set startup command
az webapp config set \
  --resource-group $RESOURCE_GROUP \
  --name $APP_NAME \
  --startup-file "cd backend && python manage.py migrate && python manage.py runserver 0.0.0.0:8000"

# 8. Tampilkan URL aplikasi
echo "üéâ Deployment selesai!"
echo "üåê Aplikasi Anda akan tersedia di: https://${APP_NAME}.azurewebsites.net"
echo "‚è≥ Tunggu 5-10 menit untuk deployment pertama selesai"

# 9. (Opsional) Monitor deployment logs
# az webapp log tail --resource-group $RESOURCE_GROUP --name $APP_NAME
